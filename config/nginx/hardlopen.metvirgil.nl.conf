# Professional Nginx Configuration for hardlopen.metvirgil.nl
# 
# This configuration properly handles proxy caching and respects Cache-Control headers
# from the Rails application.
#
# To apply this configuration:
#   sudo cp config/nginx/hardlopen.metvirgil.nl.conf /etc/nginx/sites-enabled/hardlopen.metvirgil.nl
#   sudo nginx -t
#   sudo systemctl reload nginx

server {
    server_name hardlopen.metvirgil.nl;
    root /home/vsm/webapps/hardlopen.metvirgil.nl/public;

    # Proxy to Puma
    location / {
        proxy_pass http://localhost:3001;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Respect Cache-Control headers from Rails application
        # This allows Rails to control caching behavior
        proxy_cache_bypass $http_pragma $http_cache_control;
        proxy_no_cache $http_cache_control;
        
        # Don't buffer responses for better real-time experience
        proxy_buffering off;
        
        # Pass through cache control headers
        proxy_pass_header Cache-Control;
        proxy_pass_header Pragma;
        proxy_pass_header Expires;
    }

    # Static assets should be cached aggressively
    location ~ ^/(assets|packs|images|fonts)/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        gzip_static on;
        access_log off;
    }

    # PWA files should have short cache
    location ~ ^/(manifest\.json|service-worker\.js)$ {
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # SSL Configuration (managed by Certbot)
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/hardlopen.metvirgil.nl/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hardlopen.metvirgil.nl/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name hardlopen.metvirgil.nl;
    
    if ($host = hardlopen.metvirgil.nl) {
        return 301 https://$host$request_uri;
    }
    
    return 404;
}

