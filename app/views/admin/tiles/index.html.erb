<h1 class="page-heading">Tegels per rol beheren</h1>
<p class="section-subtitle">Wijzig de zichtbaarheid, titel en volgorde van tegels. Klik op <b>Opslaan</b> om je wijzigingen op te slaan, of <b>Annuleer</b> om terug te keren naar de laatst opgeslagen situatie.</p>
<div class="tile-admin-grid">
  <% @roles.each do |role| %>
    <div class="tile-admin-column">
      <h3 class="tile-admin-column__title"><%= role %></h3>
      <form class="tile-form" data-role="<%= role %>">
        <table class="tile-admin-table">
          <tr>
            <th></th>
            <th>Dashboard</th>
            <th>Menu</th>
            <th>Apple Watch</th>
            <th style="text-align:left;">Titel</th>
          </tr>
        </table>
        <ul class="tile-sortable" data-role="<%= role %>">
          <% sorted_tiles = @tiles.map { |tile| [tile, (@tile_assignments[[role, tile[:key]]]&.first)] }
            .sort_by { |tile, assignment| assignment&.position || 999 } %>
          <% sorted_tiles.each do |tile, assignment| %>
            <li class="tile-sortable-item" data-tile="<%= tile[:key] %>">
              <span class="tile-sortable-handle" aria-hidden="true">â˜°</span>
              <span class="tile-admin-toggle">
                <label class="switch">
                  <input type="hidden" name="visible" value="0">
                  <input type="checkbox" name="visible" data-role="<%= role %>" data-tile="<%= tile[:key] %>" value="1" <%= assignment&.visible != false ? 'checked' : '' %>>
                  <span class="slider round"></span>
                </label>
              </span>
              <span class="tile-admin-toggle">
                <label class="switch">
                  <input type="hidden" name="show_in_menu" value="0">
                  <input type="checkbox" name="show_in_menu" data-role="<%= role %>" data-tile="<%= tile[:key] %>" value="1" <%= assignment&.show_in_menu != false ? 'checked' : '' %>>
                  <span class="slider round"></span>
                </label>
              </span>
              <span class="tile-admin-toggle">
                <label class="switch">
                  <input type="hidden" name="apple_watch_download" value="0">
                  <input type="checkbox" name="apple_watch_download" data-role="<%= role %>" data-tile="<%= tile[:key] %>" value="1" <%= (assignment&.respond_to?(:show_apple_watch_download) && assignment&.show_apple_watch_download != false) ? 'checked' : '' %>>
                  <span class="slider round"></span>
                </label>
              </span>
              <input type="text" name="custom_label" class="tile-label-input" data-role="<%= role %>" data-tile="<%= tile[:key] %>" value="<%= assignment&.custom_label.presence || tile[:label] %>">
            </li>
          <% end %>
        </ul>
        <div class="tile-form__actions">
          <button type="submit" class="theme-btn">Opslaan</button>
          <button type="button" class="theme-btn" onclick="window.location.reload();" style="background:#e74c3c;">Annuleer</button>
        </div>
      </form>
    </div>
  <% end %>
</div>
<div id="tile-feedback" class="tile-feedback tile-feedback--success">Opgeslagen!</div>

<script>
// Drag & drop sortering
function sortableInit() {
  document.querySelectorAll('.tile-sortable').forEach(function(list) {
    let draggingEl;
    list.querySelectorAll('.tile-sortable-item').forEach(function(item) {
      item.draggable = true;
      item.addEventListener('dragstart', function(e) {
        draggingEl = item;
        item.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      item.addEventListener('dragend', function() {
        draggingEl = null;
        item.classList.remove('dragging');
      });
    });
    list.addEventListener('dragover', function(e) {
      e.preventDefault();
      const afterEl = getDragAfterElement(list, e.clientY);
      if (afterEl == null) {
        list.appendChild(draggingEl);
      } else {
        list.insertBefore(draggingEl, afterEl);
      }
    });
  });
}
function getDragAfterElement(list, y) {
  const items = [...list.querySelectorAll('.tile-sortable-item:not(.dragging)')];
  return items.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: -Infinity }).element;
}
document.addEventListener('DOMContentLoaded', function() {
  sortableInit();
  document.querySelectorAll('.tile-form').forEach(function(form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var role = form.getAttribute('data-role');
      var tiles = Array.from(form.querySelectorAll('.tile-sortable-item')).map(function(item) {
        var key = item.getAttribute('data-tile');
        var visible = item.querySelector('input[type=checkbox][name=visible]').checked;
        var show_in_menu = item.querySelector('input[type=checkbox][name=show_in_menu]').checked;
        var apple_watch_download = item.querySelector('input[type=checkbox][name=apple_watch_download]').checked;
        var custom_label = item.querySelector('input[type=text]').value;
        return { key: key, visible: visible, show_in_menu: show_in_menu, apple_watch_download: apple_watch_download, custom_label: custom_label };
      });
      fetch('/admin/tiles/save_all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content },
        body: JSON.stringify({ role: role, tiles: tiles })
      })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        var feedback = document.getElementById('tile-feedback');
        if (data.success) {
          feedback.classList.remove('tile-feedback--error');
          feedback.classList.add('tile-feedback--success');
          feedback.style.display = 'block';
          feedback.textContent = 'Opgeslagen!';
          setTimeout(function(){ feedback.style.display = 'none'; window.location.reload(); }, 1200);
        } else {
          feedback.classList.remove('tile-feedback--success');
          feedback.classList.add('tile-feedback--error');
          feedback.style.display = 'block';
          feedback.textContent = 'Fout: ' + (data.error || 'Onbekend');
        }
      });
    });
  });
});
</script> 