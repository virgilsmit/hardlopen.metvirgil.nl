<h1>Trainingsschema's</h1>
<% if @schema_name %>
  <p class="schema-subtitle">Mijn schema: <strong><%= @schema_name %></strong></p>
<% end %>

<% if current_user&.admin? %>
  <div class="alert alert-info" style="padding: 1rem; background: #e3f2fd; border-left: 4px solid #2196f3; margin: 1rem 0;">
    <p><strong>Beheerder:</strong> Klik op een schema naam of beschrijving om deze te bewerken.</p>
  </div>
<% end %>

<table style="width:100%; border-collapse:collapse; margin-top:1rem;">
  <thead>
    <tr>
      <th style="text-align:left; padding:8px;">Naam</th>
      <th style="text-align:left; padding:8px;">Omschrijving</th>
      <th style="text-align:left; padding:8px;">Aantal sessies</th>
      <th style="text-align:left; padding:8px;">Eerste trainer</th>
      <% if current_user&.admin? %>
        <th style="text-align:left; padding:8px;">Acties</th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% Array(@schemas).each do |schema| %>
      <tr>
        <td style="padding:8px;">
          <% if current_user&.admin? %>
            <div class="editable-field" data-schema-id="<%= schema.id %>" data-field="name">
              <span class="field-value"><%= schema.name %></span>
              <button class="edit-btn" onclick="editField(this)" style="margin-left: 8px; padding: 4px 8px; font-size: 12px; background: #FC4C02; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úèÔ∏è Bewerk</button>
            </div>
          <% else %>
            <%= link_to schema.name, schema_volledig_path(id: schema.id) %>
          <% end %>
        </td>
        <td style="padding:8px;">
          <% if current_user&.admin? %>
            <div class="editable-field" data-schema-id="<%= schema.id %>" data-field="description">
              <span class="field-value"><%= schema.description %></span>
              <button class="edit-btn" onclick="editField(this)" style="margin-left: 8px; padding: 4px 8px; font-size: 12px; background: #FC4C02; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úèÔ∏è Bewerk</button>
            </div>
          <% else %>
            <%= schema.description %>
          <% end %>
        </td>
        <td style="padding:8px;"><%= schema.training_sessions.count %></td>
        <td style="padding:8px;">
          <% if current_user&.admin? %>
            <% eerste = schema.training_sessions.order(:date).first %>
            <% if eerste %>
              <%= form_with model: eerste, url: training_session_path(eerste), method: :patch, local: true, style: 'display: inline-flex; align-items: center; gap: 8px;' do |f| %>
                <%= f.collection_select :trainer_id, User.with_role(:trainer), :id, :name, { include_blank: '(geen trainer)', selected: eerste.trainer_id }, { style: 'padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;' } %>
                <%= f.submit '‚úì', class: 'theme-btn', style: 'padding: 4px 12px; font-size: 14px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;' %>
              <% end %>
            <% else %>
              -
            <% end %>
          <% else %>
            <% eerste = schema.training_sessions.order(:date).detect(&:trainer) %>
            <%= eerste&.trainer&.name || '-' %>
          <% end %>
        </td>
        <% if current_user&.admin? %>
          <td style="padding:8px;">
            <%= link_to 'Bekijk', schema_volledig_path(id: schema.id), style: 'padding: 4px 12px; background: #0EA5E9; color: white; border-radius: 4px; text-decoration: none; font-size: 12px;' %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<script>
function editField(button) {
  const container = button.closest('.editable-field');
  const schemaId = container.dataset.schemaId;
  const field = container.dataset.field;
  const valueSpan = container.querySelector('.field-value');
  const currentValue = valueSpan.textContent;
  
  // Verberg de knop en toon input
  button.style.display = 'none';
  
  // Maak input field
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentValue;
  input.style.cssText = 'padding: 6px 12px; border: 2px solid #FC4C02; border-radius: 4px; font-size: 14px; width: 300px; max-width: 100%;';
  
  // Maak save en cancel knoppen
  const saveBtn = document.createElement('button');
  saveBtn.textContent = '‚úì Opslaan';
  saveBtn.style.cssText = 'margin-left: 8px; padding: 6px 12px; background: #22C55E; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
  
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = '‚úï Annuleren';
  cancelBtn.style.cssText = 'margin-left: 4px; padding: 6px 12px; background: #6B7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
  
  // Vervang content
  valueSpan.style.display = 'none';
  container.appendChild(input);
  container.appendChild(saveBtn);
  container.appendChild(cancelBtn);
  
  input.focus();
  input.select();
  
  // Save functie
  saveBtn.onclick = async function() {
    const newValue = input.value.trim();
    if (newValue === '') {
      alert('Naam mag niet leeg zijn');
      return;
    }
    
    try {
      const response = await fetch(`/training_schemas/${schemaId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({
          training_schema: {
            [field]: newValue
          }
        })
      });
      
      if (response.ok) {
        valueSpan.textContent = newValue;
        valueSpan.style.display = '';
        input.remove();
        saveBtn.remove();
        cancelBtn.remove();
        button.style.display = '';
        
        // Toon success feedback
        const feedback = document.createElement('span');
        feedback.textContent = '‚úì Opgeslagen';
        feedback.style.cssText = 'margin-left: 8px; color: #22C55E; font-size: 12px; font-weight: 600;';
        container.appendChild(feedback);
        setTimeout(() => feedback.remove(), 2000);
      } else {
        alert('Fout bij opslaan. Probeer opnieuw.');
      }
    } catch (error) {
      alert('Fout bij opslaan: ' + error.message);
    }
  };
  
  // Cancel functie
  cancelBtn.onclick = function() {
    valueSpan.style.display = '';
    input.remove();
    saveBtn.remove();
    cancelBtn.remove();
    button.style.display = '';
  };
  
  // Enter = save, Escape = cancel
  input.onkeydown = function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      saveBtn.click();
    } else if (e.key === 'Escape') {
      cancelBtn.click();
    }
  };
}
</script>

<h1>Trainingsschema</h1>
<div class="theme-cards">
  <div class="theme-card">
    <div class="theme-card-icon">üìñ</div>
    <h2>Volledig schema</h2>
    <p>Bekijk het volledige trainingsschema van de groep.</p>
    <a href="<%= schema_volledig_path %>" class="theme-btn">Bekijk volledig schema</a>
  </div>
  <div class="theme-card">
    <div class="theme-card-icon">üóìÔ∏è</div>
    <h2>Schema van deze week</h2>
    <p>Bekijk het schema voor de huidige week.</p>
    <a href="<%= schema_week_path %>" class="theme-btn">Bekijk weekschema</a>
  </div>
  <div class="theme-card">
    <div class="theme-card-icon">üìÖ</div>
    <h2>Alle trainingen</h2>
    <p>Bekijk een lijst van alle trainingen vanaf vandaag.</p>
    <a href="<%= schema_all_path %>" class="theme-btn">Bekijk alle trainingen</a>
  </div>
  <div class="theme-card">
    <div class="theme-card-icon">üóìÔ∏è</div>
    <h2>Deze week</h2>
    <p>Bekijk alleen de trainingen van deze week.</p>
    <a href="<%= schema_dezeweek_path %>" class="theme-btn">Bekijk deze week</a>
  </div>
</div>

<!-- WEEKOVERZICHT -->
<%= render partial: 'week_overview' %>

<!-- ALLE AANKOMENDE TRAININGEN -->
<% if @schema_name.present? %>
  <p style="color:#888;">Schema: <strong><%= @schema_name %></strong></p>
  <p style="color:#888;">Aantal aankomende trainingen vanaf vandaag: <%= @upcoming_sessions.size %></p>
  <h2 style="margin-top:2.5em;">Alle aankomende trainingen vanaf vandaag</h2>
<% elsif @upcoming_sessions.empty? %>
  <div class="alert alert-info" style="padding: 1rem; background: #e3f2fd; border-left: 4px solid #2196f3; margin: 1rem 0;">
    <p><strong>Geen trainingsschema ingesteld</strong></p>
    <p>Je hebt nog geen persoonlijk trainingsschema gekozen. Ga naar je <a href="<%= profile_path %>">profiel</a> om een standaard schema te selecteren.</p>
  </div>
<% end %>
<% if @upcoming_sessions.present? %>
  <table style="width:100%; border-collapse:collapse; margin-top:1rem;">
    <thead>
      <tr>
        <th style="text-align:left; padding:8px;">Datum</th>
        <th style="text-align:left; padding:8px;">Dag</th>
        <th style="text-align:left; padding:8px;">Training</th>
        <th style="text-align:left; padding:8px;">Loopscholing</th>
        <th style="text-align:left; padding:8px;">Trainer</th>
        <th style="text-align:left; padding:8px;">Locatie</th>
        <th style="text-align:left; padding:8px;">Fase</th>
        <th style="text-align:left; padding:8px;">Wedstrijd</th>
      </tr>
    </thead>
    <tbody>
      <% @upcoming_sessions.each do |sessie| %>
        <tr>
          <td style="padding:8px;"><%= sessie.date %></td>
          <td style="padding:8px;"><%= sessie.dag %></td>
          <td style="padding:8px;"><%= sessie.description %></td>
          <td style="padding:8px;"><%= sessie.loopscholing %></td>
          <td style="padding:8px;"><%= sessie.trainer || (sessie.trainer_id && User.find_by(id: sessie.trainer_id)&.name) || '-' %></td>
          <td style="padding:8px;">GAC</td>
          <td style="padding:8px;"><%= sessie.fase %></td>
          <td style="padding:8px;"><%= sessie.wedstrijd %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
