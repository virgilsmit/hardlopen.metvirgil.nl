<% schema_name = @schemas.any? ? @schemas.first.name : nil %>
<% if schema_name.present? %>
  <h1>Mijn schema: <%= schema_name %></h1>
<% else %>
  <h1>Mijn schema</h1>
<% end %>

<% if @upcoming_sessions.present? || @past_sessions.present? %>
  <!-- KOMMENDE TRAININGEN -->
  <% if @upcoming_sessions.present? %>
    <h2 style="margin-top:2em;">Komende trainingen</h2>
    <table class="schema-table" style="width:100%; border-collapse:collapse; margin-bottom:2rem;">
      <thead>
        <tr>
          <th class="schema-table__th">Datum</th>
          <th class="schema-table__th">Dag</th>
          <th class="schema-table__th">Training</th>
          <th class="schema-table__th">Loopscholing</th>
          <th class="schema-table__th">Trainer</th>
          <th class="schema-table__th">Locatie</th>
          <th class="schema-table__th">Fase</th>
          <th class="schema-table__th">Wedstrijd</th>
          <% if current_user %>
            <th class="schema-table__th">Status</th>
            <th class="schema-table__th">Aan-/afmelden</th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @upcoming_sessions.each do |sessie| %>
          <% if current_user %>
            <% my_attendance = sessie.attendances.find { |a| a.user_id == current_user.id } %>
          <% end %>
          <tr class="schema-table__row" onclick="if(event.target.tagName !== 'BUTTON' && event.target.tagName !== 'INPUT' && !event.target.closest('.attendance-buttons')){window.location='/training_sessions/<%= sessie.id %>'}" style="cursor:pointer;">
            <td style="padding:8px; white-space:nowrap;"><%= l(sessie.date) %></td>
            <td style="padding:8px;">
              <% if sessie.dag.to_s.downcase == 'zaterdag' %>
                Zaterdag 08:45
              <% elsif sessie.dag.to_s.downcase == 'dinsdag' %>
                Dinsdag 18:45
              <% else %>
                <%= sessie.dag %>
              <% end %>
            </td>
            <td style="padding:8px;"><%= sessie.description %></td>
            <td style="padding:8px;"><%= sessie.loopscholing %></td>
            <td style="padding:8px;">
              <% if sessie.dag.to_s.downcase == 'donderdag' || sessie.dag.to_s.downcase == 'zondag' %>
                Zelf
              <% else %>
                <%= sessie.trainer&.name || '-' %>
              <% end %>
            </td>
            <td style="padding:8px;"><%= sessie.locatie || 'GAC' %></td>
            <td style="padding:8px;"><%= sessie.fase %></td>
            <td style="padding:8px;"><%= sessie.wedstrijd %></td>
            <% if current_user && (sessie.group_id.nil? || current_user.groups.pluck(:id).include?(sessie.group_id)) %>
              <td style="padding:8px;">
                <% if my_attendance&.status == 'aanwezig' %>
                  <span class="status-dot status-aanwezig"></span>
                  <span class="status-text status-aanwezig-text">Aanwezig</span>
                <% elsif my_attendance&.status == 'afwezig' %>
                  <span class="status-dot status-afwezig"></span>
                  <span class="status-text status-afwezig-text">Afwezig</span>
                  <% if my_attendance.note.present? %>
                    <span class="attendance-note">- <%= my_attendance.note %></span>
                  <% end %>
                <% else %>
                  <span class="status-dot status-onbekend"></span>
                  <span class="status-text status-onbekend-text">Geen status</span>
                <% end %>
              </td>
              <td style="padding:8px;" onclick="event.stopPropagation();">
                <div class="attendance-buttons">
                  <%= form_with url: attendances_path, method: :post, local: true, class: 'inline-form' do |f| %>
                    <%= f.hidden_field :user_id, value: current_user.id %>
                    <%= f.hidden_field :training_session_id, value: sessie.id %>
                    <%= f.hidden_field :status, value: 'aanwezig' %>
                    <button type="submit" class="theme-btn attendance-btn attendance-aanwezig-btn <%= (my_attendance.nil? || my_attendance.status == 'aanwezig') ? 'active' : 'inactive' %>">Aanw.</button>
                  <% end %>
                  <%= form_with url: attendances_path, method: :post, local: true, html: { class: 'afwezig-form', data: { session_id: sessie.id } }, class: 'inline-form' do |f| %>
                    <%= f.hidden_field :user_id, value: current_user.id %>
                    <%= f.hidden_field :training_session_id, value: sessie.id %>
                    <%= f.hidden_field :status, value: 'afwezig' %>
                    <div class="afwezig-container">
                      <% if my_attendance&.status == 'afwezig' %>
                        <button type="submit" class="theme-btn afwezig-submit" data-session-id="<%= sessie.id %>">OK</button>
                      <% else %>
                        <button type="submit" class="theme-btn afwezig-btn inactive" data-session-id="<%= sessie.id %>">âœ—</button>
                      <% end %>
                      <%# Notitieveld altijd tonen als status afwezig is, anders verborgen %>
                      <div class="afwezig-note-field" id="afwezig-note-<%= sessie.id %>" class="<%= my_attendance&.status == 'afwezig' ? '' : 'hidden' %>">
                        <%= f.text_field :note, value: (my_attendance&.status == 'afwezig' ? my_attendance&.note : nil), placeholder: 'Notitie (optioneel)', class: 'note-input-full' %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </td>
            <% elsif current_user %>
              <td style="padding:8px;">-</td>
              <td style="padding:8px;">-</td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <!-- VERLEDEN TRAININGEN -->
  <% if @past_sessions.present? %>
    <h2 style="margin-top:2.5em;">Verleden trainingen</h2>
    <table class="schema-table" style="width:100%; border-collapse:collapse; margin-bottom:2rem;">
      <thead>
        <tr>
          <th class="schema-table__th">Datum</th>
          <th class="schema-table__th">Dag</th>
          <th class="schema-table__th">Training</th>
          <th class="schema-table__th">Loopscholing</th>
          <th class="schema-table__th">Trainer</th>
          <th class="schema-table__th">Locatie</th>
          <th class="schema-table__th">Fase</th>
          <th class="schema-table__th">Wedstrijd</th>
          <% if current_user %>
            <th class="schema-table__th">Status</th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @past_sessions.each do |sessie| %>
          <% if current_user %>
            <% my_attendance = sessie.attendances.find { |a| a.user_id == current_user.id } %>
          <% end %>
          <tr class="schema-table__row" onclick="if(event.target.tagName !== 'BUTTON' && event.target.tagName !== 'INPUT' && !event.target.closest('.attendance-buttons')){window.location='/training_sessions/<%= sessie.id %>'}" style="cursor:pointer;">
            <td style="padding:8px; white-space:nowrap;"><%= l(sessie.date) %></td>
            <td style="padding:8px;">
              <% if sessie.dag.to_s.downcase == 'zaterdag' %>
                Zaterdag 08:45
              <% elsif sessie.dag.to_s.downcase == 'dinsdag' %>
                Dinsdag 18:45
              <% else %>
                <%= sessie.dag %>
              <% end %>
            </td>
            <td style="padding:8px;"><%= sessie.description %></td>
            <td style="padding:8px;"><%= sessie.loopscholing %></td>
            <td style="padding:8px;">
              <% if sessie.dag.to_s.downcase == 'donderdag' || sessie.dag.to_s.downcase == 'zondag' %>
                Zelf
              <% else %>
                <%= sessie.trainer&.name || '-' %>
              <% end %>
            </td>
            <td style="padding:8px;"><%= sessie.locatie || 'GAC' %></td>
            <td style="padding:8px;"><%= sessie.fase %></td>
            <td style="padding:8px;"><%= sessie.wedstrijd %></td>
            <% if current_user %>
              <td style="padding:8px;">
                <% if my_attendance&.status == 'aanwezig' %>
                  <span class="status-dot status-aanwezig"></span>
                  <span class="status-text status-aanwezig-text">Aanwezig</span>
                <% elsif my_attendance&.status == 'afwezig' %>
                  <span class="status-dot status-afwezig"></span>
                  <span class="status-text status-afwezig-text">Afwezig</span>
                  <% if my_attendance.note.present? %>
                    <span class="attendance-note">- <%= my_attendance.note %></span>
                  <% end %>
                <% else %>
                  <span class="status-dot status-onbekend"></span>
                  <span class="status-text status-onbekend-text">Geen status</span>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
<% else %>
  <div class="alert alert-info" style="padding: 1rem; background: #e3f2fd; border-left: 4px solid #2196f3; margin: 1rem 0;">
    <p><strong>Geen trainingsschema ingesteld</strong></p>
    <p>Je hebt nog geen persoonlijk trainingsschema gekozen. Ga naar je <a href="<%= profile_path %>">profiel</a> om een standaard schema te selecteren.</p>
  </div>
<% end %>
