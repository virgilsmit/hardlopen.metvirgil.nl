<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FC4C02">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Hardlopen">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#FC4C02">
    <meta name="msapplication-tap-highlight" content="no">
    
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <%= stylesheet_link_tag "application", media: "all", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
    <%= favicon_link_tag 'RunForFun-zwart.svg' %>
  </head>

  <body>
    <div class="app-container">
      <header class="theme-header">
        <%= link_to root_path, class: 'theme-header__logo-link' do %>
          <%= image_tag 'RunForFun-zwart.svg', alt: 'Run For Fun logo', class: 'theme-header__logo', size: '48x48' %>
        <% end %>
        <span class="theme-header__title">Hardlopen met Virgil</span>
        
        <!-- Mobile menu button -->
        <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        
        <button id="install-button" class="app-btn" style="display: none; font-size: 0.8rem; padding: 0.5rem 1rem;">Installeer App</button>
      </header>
      
      <!-- Desktop Navigation -->
      <nav class="theme-menu desktop-menu">
        <div class="theme-menu__inner">
          <a href="/" class="theme-btn">ğŸ  Home</a>
          
          <% if logged_in? %>
            <% training_tiles = visible_tiles_for_menu(current_user).select { |t| ['dezeweek', 'all_trainings', 'schema', 'vandaag'].include?(t[:key]) } %>
            <% if training_tiles.any? %>
              <div class="dropdown">
                <button type="button" class="theme-btn dropdown-toggle" aria-expanded="false">ğŸƒâ€â™‚ï¸ Training</button>
                <div class="dropdown-menu">
                  <% training_tiles.each do |tile| %>
                    <a href="<%= tile[:url] %>" class="dropdown-item"><%= tile[:label] %></a>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- Beheer -->
            <% beheer_tiles = visible_tiles_for_menu(current_user).select { |t| ['groups', 'users', 'profielen', 'photos', 'statuses'].include?(t[:key]) } %>
            <% if beheer_tiles.any? %>
              <div class="dropdown">
                <button type="button" class="theme-btn dropdown-toggle" aria-expanded="false">âš™ï¸ Beheer</button>
                <div class="dropdown-menu">
                  <% beheer_tiles.each do |tile| %>
                    <a href="<%= tile[:url] %>" class="dropdown-item"><%= tile[:label] %></a>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- Trainers -->
            <% if visible_tiles_for_menu(current_user).any? { |t| ['trainers', 'trainers_overzicht', 'ad_gemiddelden', 'birthdays', 'birthdays_30'].include?(t[:key]) } %>
              <div class="dropdown">
                <button type="button" class="theme-btn dropdown-toggle" aria-expanded="false">ğŸ‘¨â€ğŸ« Trainers</button>
                <div class="dropdown-menu">
                  <% visible_tiles_for_menu(current_user).select { |t| ['trainers', 'trainers_overzicht', 'ad_gemiddelden', 'birthdays', 'birthdays_30'].include?(t[:key]) }.each do |tile| %>
                    <a href="<%= tile[:url] %>" class="dropdown-item"><%= tile[:label] %></a>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- Intake -->
            <% intake_tile = visible_tiles_for_menu(current_user).find { |t| t[:key] == 'intake' } %>
            <% if intake_tile %>
              <a href="<%= intake_tile[:url] %>" class="theme-btn theme-btn--outline">ğŸ“ <%= intake_tile[:label] %></a>
            <% end %>

            <!-- Admin -->
            <% admin_tiles = visible_tiles_for_menu(current_user).select { |t| ['admin', 'tiles', 'import', 'intakes'].include?(t[:key]) } %>
            <% if admin_tiles.any? %>
              <div class="dropdown">
                <button type="button" class="theme-btn dropdown-toggle" aria-expanded="false">ğŸ› ï¸ Admin</button>
                <div class="dropdown-menu">
                  <% admin_tiles.each do |tile| %>
                    <a href="<%= tile[:url] %>" class="dropdown-item"><%= tile[:label] %></a>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- Profiel & Logout -->
            <div class="dropdown">
              <button type="button" class="theme-btn dropdown-toggle" aria-expanded="false">ğŸ‘¤ <%= current_user.name %></button>
              <div class="dropdown-menu">
                <a href="/profile" class="dropdown-item">Mijn Profiel</a>
                <%= link_to "Logout", logout_path, method: :delete, class: "dropdown-item" %>
              </div>
            </div>
          <% else %>
            <% # Voor niet-ingelogde gebruikers: check standaard tile assignments %>
            <% guest_tiles = TileAssignment.where(role: 'user').where(show_in_menu: true).pluck(:tile_key) %>
            <% if guest_tiles.include?('login') || guest_tiles.empty? %>
              <a href="/login" class="theme-btn">ğŸ”‘ Login</a>
            <% end %>
            <% if guest_tiles.include?('register') || guest_tiles.empty? %>
              <a href="/register" class="theme-btn">ğŸ“ Register</a>
            <% end %>
            <% if guest_tiles.include?('intake') || guest_tiles.empty? %>
              <a href="<%= intake_path %>" class="theme-btn theme-btn--outline">ğŸ“ Intake</a>
            <% end %>
          <% end %>
        </div>
      </nav>

      <!-- Mobile Navigation Overlay -->
      <div id="mobile-menu-overlay" class="mobile-menu-overlay">
        <nav class="mobile-menu">
          <div class="mobile-menu__header">
            <h3>Menu</h3>
            <button id="mobile-menu-close" class="mobile-menu-close">âœ•</button>
          </div>
          
          <div class="mobile-menu__content">
            <a href="/" class="mobile-menu__item">
              <span class="mobile-menu__icon">ğŸ </span>
              <span>Home</span>
            </a>
            
            <% if logged_in? %>
              <% mobile_training_tiles = visible_tiles_for_menu(current_user).select { |t| ['dezeweek', 'all_trainings', 'schema', 'vandaag'].include?(t[:key]) } %>
              <% if mobile_training_tiles.any? %>
                <div class="mobile-menu__section">
                  <h4>ğŸƒâ€â™‚ï¸ Training</h4>
                  <% mobile_training_tiles.each do |tile| %>
                    <a href="<%= tile[:url] %>" class="mobile-menu__item">
                      <span class="mobile-menu__icon">
                        <% case tile[:key] %>
                        <% when 'dezeweek' %>
                          ğŸ“…
                        <% when 'all_trainings' %>
                          ğŸ“‹
                        <% when 'schema' %>
                          ğŸ—“ï¸
                        <% when 'vandaag' %>
                          ğŸ“²
                        <% else %>
                          ğŸƒ
                        <% end %>
                      </span>
                      <span><%= tile[:label] %></span>
                    </a>
                  <% end %>
                </div>
              <% end %>
              
              <!-- Beheer Section -->
              <% mobile_beheer_tiles = visible_tiles_for_menu(current_user).select { |t| ['groups', 'users', 'profielen', 'photos', 'statuses'].include?(t[:key]) } %>
              <% if mobile_beheer_tiles.any? %>
                <div class="mobile-menu__section">
                  <h4>âš™ï¸ Beheer</h4>
                  <% mobile_beheer_tiles.each do |tile| %>
                    <a href="<%= tile[:url] %>" class="mobile-menu__item">
                      <span class="mobile-menu__icon">
                        <% case tile[:key] %>
                        <% when 'groups' %>
                          ğŸ‘¥
                        <% when 'users', 'profielen' %>
                          ğŸ‘¤
                        <% when 'photos' %>
                          ğŸ“·
                        <% when 'statuses' %>
                          ğŸ”„
                        <% else %>
                          âš™ï¸
                        <% end %>
                      </span>
                      <span><%= tile[:label] %></span>
                    </a>
                  <% end %>
                </div>
              <% end %>
              
              <!-- Trainers Section -->
              <% if visible_tiles_for_menu(current_user).any? { |t| ['trainers', 'trainers_overzicht', 'ad_gemiddelden', 'birthdays', 'birthdays_30'].include?(t[:key]) } %>
                <div class="mobile-menu__section">
                  <h4>ğŸ‘¨â€ğŸ« Trainers</h4>
                  <% visible_tiles_for_menu(current_user).select { |t| ['trainers', 'trainers_overzicht', 'ad_gemiddelden', 'birthdays', 'birthdays_30'].include?(t[:key]) }.each do |tile| %>
                    <a href="<%= tile[:url] %>" class="mobile-menu__item">
                      <span class="mobile-menu__icon">
                        <% case tile[:key] %>
                        <% when 'trainers' %>
                          ğŸ‘¨â€ğŸ«
                        <% when 'trainers_overzicht' %>
                          ğŸ“Š
                        <% when 'ad_gemiddelden' %>
                          ğŸ“ˆ
                        <% when 'birthdays', 'birthdays_30' %>
                          ğŸ‚
                        <% else %>
                          ğŸ‘¨â€ğŸ«
                        <% end %>
                      </span>
                      <span><%= tile[:label] %></span>
                    </a>
                  <% end %>
                </div>
              <% end %>
              
              <% mobile_intake_tile = visible_tiles_for_menu(current_user).find { |t| t[:key] == 'intake' } %>
              <% if mobile_intake_tile %>
                <a href="<%= mobile_intake_tile[:url] %>" class="mobile-menu__item">
                  <span class="mobile-menu__icon">ğŸ“</span>
                  <span><%= mobile_intake_tile[:label] %></span>
                </a>
              <% end %>

              <!-- Admin Section -->
              <% mobile_admin_tiles = visible_tiles_for_menu(current_user).select { |t| ['admin', 'tiles', 'import', 'intakes'].include?(t[:key]) } %>
              <% if mobile_admin_tiles.any? %>
                <div class="mobile-menu__section">
                  <h4>ğŸ› ï¸ Admin</h4>
                  <% mobile_admin_tiles.each do |tile| %>
                    <a href="<%= tile[:url] %>" class="mobile-menu__item">
                      <span class="mobile-menu__icon">
                        <% case tile[:key] %>
                        <% when 'admin' %>
                          ğŸ› ï¸
                        <% when 'tiles' %>
                          ğŸ§©
                        <% when 'import' %>
                          ğŸ“¥
                        <% when 'intakes' %>
                          ğŸ“‹
                        <% else %>
                          âš™ï¸
                        <% end %>
                      </span>
                      <span><%= tile[:label] %></span>
                    </a>
                  <% end %>
                </div>
              <% end %>
              
              <!-- Profiel Section -->
              <div class="mobile-menu__section">
                <h4>ğŸ‘¤ <%= current_user.name %></h4>
                <a href="/profile" class="mobile-menu__item">
                  <span class="mobile-menu__icon">ğŸ‘¤</span>
                  <span>Mijn Profiel</span>
                </a>
                <%= link_to logout_path, method: :delete, class: "mobile-menu__item" do %>
                  <span class="mobile-menu__icon">ğŸšª</span>
                  <span>Logout</span>
                <% end %>
              </div>
            <% else %>
              <div class="mobile-menu__section">
                <% # Voor niet-ingelogde gebruikers: check standaard tile assignments %>
                <% guest_tiles = TileAssignment.where(role: 'user').where(show_in_menu: true).pluck(:tile_key) %>
                <% if guest_tiles.include?('login') || guest_tiles.empty? %>
                  <a href="/login" class="mobile-menu__item">
                    <span class="mobile-menu__icon">ğŸ”‘</span>
                    <span>Login</span>
                  </a>
                <% end %>
                <% if guest_tiles.include?('register') || guest_tiles.empty? %>
                  <a href="/register" class="mobile-menu__item">
                    <span class="mobile-menu__icon">ğŸ“</span>
                    <span>Register</span>
                  </a>
                <% end %>
                <% if guest_tiles.include?('intake') || guest_tiles.empty? %>
                  <a href="<%= intake_path %>" class="mobile-menu__item">
                    <span class="mobile-menu__icon">ğŸ“</span>
                    <span>Intake</span>
                  </a>
                <% end %>
              </div>
            <% end %>
          </div>
        </nav>
      </div>
      
      <main class="theme-main surface-dark">
        <% if flash[:notice] %>
          <div class="alert-card alert-success"><%= flash[:notice] %></div>
        <% end %>
        <% if flash[:alert] %>
          <div class="alert-card"><%= flash[:alert] %></div>
        <% end %>
        <%= yield %>
      </main>
      
      <!-- Bottom Navigation voor mobiel -->
      <nav class="app-bottom-nav" style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; height: 70px; background: var(--color-header); border-top: 1px solid var(--color-border); display: flex; box-shadow: 0 -4px 16px rgba(0,0,0,0.08); backdrop-filter: blur(10px);">
        <div class="app-bottom-nav__inner">
          <a href="/" class="app-bottom-nav__item">
            <div class="app-bottom-nav__icon">ğŸ </div>
          </a>
          <% if logged_in? %>
            <% visible_tiles_for_menu(current_user).first(3).each do |tile| %>
              <a href="<%= tile[:url] %>" class="app-bottom-nav__item">
                <div class="app-bottom-nav__icon">
                  <% case tile[:label].downcase %>
                  <% when /training/ %>
                    ğŸƒ
                  <% when /schema/ %>
                    ğŸ“…
                  <% when /prestatie/ %>
                    ğŸ“Š
                  <% when /groep/ %>
                    ğŸ‘¥
                  <% when /foto/ %>
                    ğŸ“·
                  <% else %>
                    ğŸ“‹
                  <% end %>
                </div>

              </a>
            <% end %>
            <a href="/profile" class="app-bottom-nav__item">
              <div class="app-bottom-nav__icon">ğŸ‘¤</div>
            </a>
          <% else %>
            <a href="/login" class="app-bottom-nav__item">
              <div class="app-bottom-nav__icon">ğŸ”‘</div>
            </a>
            <a href="/register" class="app-bottom-nav__item">
              <div class="app-bottom-nav__icon">ğŸ“</div>
            </a>
          <% end %>
        </div>
      </nav>

      <footer class="theme-main surface-dark app-footer">
        <p>&copy; 2025 Hardlopen met Virgil. Alle rechten voorbehouden.</p>
      </footer>
    </div>

    <script>
      // Mobile menu + dropdown functionality
      document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const mobileMenuClose = document.getElementById('mobile-menu-close');
        const dropdowns = document.querySelectorAll('.theme-menu .dropdown');

        function openMobileMenu() {
          mobileMenuOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
          mobileMenuOverlay.classList.remove('active');
          document.body.style.overflow = '';
        }

        if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', openMobileMenu);
        if (mobileMenuClose) mobileMenuClose.addEventListener('click', closeMobileMenu);
        if (mobileMenuOverlay) {
          mobileMenuOverlay.addEventListener('click', function(e) {
            if (e.target === mobileMenuOverlay) {
              closeMobileMenu();
            }
          });
        }

        function closeAllDropdowns() {
          dropdowns.forEach(function(dropdown) {
            dropdown.classList.remove('open');
            const toggle = dropdown.querySelector('.dropdown-toggle');
            if (toggle) toggle.setAttribute('aria-expanded', 'false');
          });
        }

        dropdowns.forEach(function(dropdown) {
          const toggle = dropdown.querySelector('.dropdown-toggle');
          if (!toggle) return;

          toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const isOpen = dropdown.classList.contains('open');
            closeAllDropdowns();

            if (!isOpen) {
              dropdown.classList.add('open');
              toggle.setAttribute('aria-expanded', 'true');
            }
          });
        });

        document.addEventListener('click', function(e) {
          if (!e.target.closest('.theme-menu .dropdown')) {
            closeAllDropdowns();
          }
        });

        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeMobileMenu();
            closeAllDropdowns();
          }
        });
      });
    </script>
  </body>
</html>
