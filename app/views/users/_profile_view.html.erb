<div class="profile-page surface-dark">
  <h1 class="profile-title"><%= @user.name %></h1>
  <p class="profile-stat"><strong>Aanwezige trainingen tot nu toe:</strong> <%= @user.attended_trainings_count_up_to_today %></p>

  <div class="profile-header-row">
    <div class="profile-left card-surface">
      <p>Status: <%= @user.status&.name || 'onbekend' %></p>
      <% user_roles = (@user.roles.presence || [@user.role]) %>
      <p>Rol: <%= user_roles.compact.map { |r| r.to_s.humanize }.join(', ') %></p>
      <p>Email: <%= @user.email %></p>
      <p>Telefoon: <%= @user.phone.presence || '-' %></p>
      <p>Geboortedatum: <%= @user.birthday.present? ? @user.birthday.strftime('%d-%m-%Y') : '-' %></p>
      <p>Noodcontact: <%= @user.emergency_contact.presence || '-' %></p>
      <% primary_role = @user.roles.presence&.first || User.roles.key(@user[:role]) || 'user' %>
      <% extra_roles = (@user.roles || []).drop(1) %>
      <% all_roles = [primary_role, *extra_roles].compact.uniq %>
      <p>Rol(len): <%= all_roles.map { |r| r.to_s.humanize }.join(', ') %></p>
      <p>Groep: <%= @user.groups.first&.name || 'Geen groep' %></p>
      <% if current_user&.admin? %>
        <p>Standaard schema: <%= @user.default_training_schema&.name || 'Geen' %></p>
      <% end %>
      <p>Hoofdtrainer: <%= @user.groups.first&.hoofdtrainer&.email || 'Geen hoofdtrainer' %></p>
      <p>Medetrainer: <%= @user.groups.first&.medetrainer&.email || 'Geen medetrainer' %></p>
    </div>

    <div class="profile-conditie">
      <% if @performances.any? %>
        <% laatste = @performances.order(:date).last %>
        <% if laatste %>
          <div class="conditie-blok card-surface">
            <strong class="conditie-title">Conditie</strong>
            <strong>Duurloop 85% (gemiddelde):</strong> <%= @user.gemiddelde_dl2_85 %><br>
            <strong>Intervaltempo (min/km):</strong> <%= @user.gemiddelde_tempo_per_km %><br>
            <strong>10 km-prognose:</strong> <%= @user.gemiddelde_prognose_10km %><br>
            <hr class="conditie-hr">
            <strong class="conditie-highlight">Anaerobe drempel</strong>
            <span class="conditie-value"><%= @user.gemiddelde_ad %></span><br>
            <hr class="conditie-hr">
            <strong class="conditie-highlight">AD Historie</strong><br>
            <% @performances.reorder(date: :desc).limit(10).each do |p| %>
              <%= p.date&.strftime('%d-%m-%Y') %>: <%= ad(p) %><br>
            <% end %>
          </div>

          <% if FeatureFlags.trainingsconditie_enabled? %>
            <div class="conditie-blok card-surface">
              <strong class="conditie-title">Trainingsconditie</strong>
              <strong>Duurloop 85% (training):</strong> <%= @user.effective_training_tempo('duur').presence || '‚Äì' %><br>
              <strong>Intervaltempo (min/km, training):</strong> <%= @user.effective_training_tempo('interval').presence || '‚Äì' %><br>
              <hr class="conditie-hr">
              <strong class="conditie-highlight">Anaerobe drempel (training)</strong>
              <span class="conditie-value"><%= @user.gemiddelde_training_ad.presence || '‚Äì' %></span><br>
              <strong>10 km-prognose (training):</strong> <%= @user.training_prognose_10km.presence || '‚Äì' %><br>
              <% if @user.training_results.any? %>
                <hr class="conditie-hr">
                <strong class="conditie-highlight">AD Historie (training)</strong><br>
                <% valid_trs = @user.training_results.includes(:training_session).select { |tr| @user.ad_training(tr).present? && @user.ad_training(tr) != '00:00' } %>
                <% grouped = valid_trs.group_by { |tr| (tr.training_session&.date || tr.created_at.to_date) } %>
                <% grouped.values.map { |arr| arr.first }.sort_by { |tr| tr.training_session&.date || tr.created_at }.reverse.each do |tr| %>
                  <%= (tr.training_session&.date || tr.created_at).strftime('%d-%m-%Y') %>: <%= @user.ad_training(tr) %><br>
                <% end %>
              <% end %>
              <% unless @user.effective_training_tempo('duur').present? || @user.effective_training_tempo('interval').present? %>
                <small>Wordt automatisch weergegeven zodra je trainingsregistraties opslaat.</small>
              <% end %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="card-surface profile-callout" style="background: linear-gradient(135deg, rgba(252, 76, 2, 0.1) 0%, rgba(255, 107, 53, 0.1) 100%); border: 2px solid rgba(252, 76, 2, 0.3); padding: 20px; border-radius: 12px;">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
      <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #FC4C02 0%, #FF6B35 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(252, 76, 2, 0.3);">
        üèÉ
      </div>
      <strong style="font-size: 18px; color: #FC4C02;">Snel Afmelden</strong>
    </div>
    
    <p style="margin-bottom: 12px; color: #f4f8ff;">
      Gebruik deze persoonlijke link om je <strong>zonder inloggen</strong> af te melden voor de training van vandaag:
    </p>
    
    <div style="background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(255, 255, 255, 0.2);">
      <code style="font-size: 12px; color: #1ee3cf; word-break: break-all; display: block;">
        <%= public_afmelden_url(slug: @user.slug, token: @user.public_token) %>
      </code>
    </div>
    
    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
      <a href="<%= public_afmelden_path(slug: @user.slug, token: @user.public_token) %>" 
         class="afmelden-test-btn"
         style="display: inline-block; background: linear-gradient(135deg, #FC4C02 0%, #FF6B35 100%); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; box-shadow: 0 4px 12px rgba(252, 76, 2, 0.3); flex: 1; text-align: center;">
        üèÉ Open afmeldpagina
      </a>
      
      <button onclick="copyToClipboard('<%= public_afmelden_url(slug: @user.slug, token: @user.public_token) %>')"
              style="background: rgba(30, 227, 207, 0.2); color: #1ee3cf; padding: 12px 20px; border: 1px solid #1ee3cf; border-radius: 8px; font-weight: 600; cursor: pointer;">
        üìã Kopieer
      </button>
    </div>
    
    <!-- Mobile Home Screen Instructies - Prominent -->
    <a href="<%= public_afmelden_path(slug: @user.slug, token: @user.public_token) %>" 
       style="display: block; background: linear-gradient(135deg, #1ee3cf 0%, #34c759 100%); border-radius: 16px; padding: 24px; margin-bottom: 16px; text-decoration: none; box-shadow: 0 8px 24px rgba(30, 227, 207, 0.4); border: 3px solid rgba(30, 227, 207, 0.2);">
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
        <div style="font-size: 56px; filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));">üì±</div>
        <div style="flex: 1;">
          <div style="color: #0c1730; font-weight: 800; font-size: 20px; margin-bottom: 4px;">
            Zet op Beginscherm
          </div>
          <div style="color: rgba(12, 23, 48, 0.8); font-size: 14px; line-height: 1.4;">
            E√©n-klik afmelden zonder inloggen
          </div>
        </div>
        <div style="font-size: 32px; color: #0c1730;">‚Üí</div>
      </div>
      
      <div style="background: rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 16px;">
        <div style="color: #0c1730; font-size: 13px; line-height: 1.6; font-weight: 600;">
          <div style="margin-bottom: 8px;">üçé <strong>iPhone:</strong> Deel ‚Üí "Zet op beginscherm"</div>
          <div>ü§ñ <strong>Android:</strong> Menu ‚Üí "Toevoegen aan startscherm"</div>
        </div>
      </div>
    </a>
    
    <small style="display: block; text-align: center; padding: 12px; background: rgba(30, 227, 207, 0.1); border-radius: 8px; margin-bottom: 16px;">
      <span style="color: #1ee3cf; font-weight: 700;">üí° Pro Tip:</span><br>
      <span style="color: rgba(244, 248, 255, 0.8); font-size: 13px;">
        Tik op de groene knop hierboven voor stap-voor-stap instructies op je telefoon!
      </span>
    </small>
    
    <small style="display: block; margin-top: 8px; color: rgba(244, 248, 255, 0.7); font-size: 12px;">
      üí° <strong>Voordeel:</strong> E√©n klik afmelden zonder inloggen - ideaal voor onderweg!
    </small>
    
    <small style="display: block; margin-top: 12px; color: rgba(244, 248, 255, 0.6); font-size: 12px;">
      ‚ö†Ô∏è Let op: deze link is persoonlijk en alleen geldig voor jouw account. Deel deze link niet met anderen.
    </small>
  </div>

  <script>
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        alert('‚úì Link gekopieerd! Je kunt deze nu delen of opslaan.');
      }, function(err) {
        // Fallback voor oudere browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('‚úì Link gekopieerd!');
      });
    }
  </script>

  <h2 style="color: #ffffff !important; font-weight: 700 !important;">Trainingsdagen</h2>
  <%= form_with url: update_training_days_path, method: :patch, local: true do |f| %>
    <% if (current_user.admin? || current_user.trainer?) && current_user.id != @user.id %>
      <%= hidden_field_tag :user_id, @user.id %>
    <% end %>
    <div class="training-days">
      <% %w[Maandag Dinsdag Woensdag Donderdag Vrijdag Zaterdag Zondag].each do |day| %>
        <label>
          <%= check_box_tag 'user[training_days][]', day, @user.training_days.present? ? @user.training_days.include?(day) : false %>
          <span><%= day %></span>
        </label>
      <% end %>
    </div>
    <%= f.submit 'Opslaan', class: 'theme-btn track-btn--glow training-days__submit' %>
  <% end %>

  <div class="profile-links">
    <%= link_to '‚úèÔ∏è Profiel', edit_user_path(@user), class: 'theme-btn track-btn--glow' %>
    <% if current_user == @user || current_user&.has_role?(:trainer) || current_user&.has_role?(:admin) %>
      <% zones_tile = visible_tiles_for_menu(current_user).find { |t| t[:key] == 'zones' } %>
      <% if zones_tile %>
        <%= link_to "üíì #{zones_tile[:label]}", zones_tile[:url], class: 'theme-btn track-btn--glow' %>
      <% end %>
    <% end %>
    <%= link_to 'Terug', users_path, class: 'theme-btn track-btn--outline' %>
  </div>

  <div class="card-surface">
    <h2>Prestaties</h2>
    <% if @performances.any? %>
      <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 1rem;">Klik op een prestatie om de volledige statistieken te bekijken</p>
      <div class="performances-table-wrapper">
        <table class="schema-table performances-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Onderdeel</th>
              <th>Afstand</th>
              <th>Tijd</th>
              <th>Gem. Hartslag</th>
              <th>km/min</th>
              <th>Notities</th>
              <% if current_user&.admin? || current_user&.id == @user.id %>
<th>Acties</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @performances.each do |performance| %>
              <tr class="performance-row clickable-row" data-performance-id="<%= performance.id %>">
                <td data-label="Datum"><%= performance.date&.strftime('%d-%m-%Y') %></td>
                <td data-label="Onderdeel"><%= performance.test_type %></td>
                <td data-label="Afstand"><%= performance.distance %></td>
                <td data-label="Tijd"><%= performance.value %></td>
                <td data-label="Gem. Hartslag"><%= performance.core_heart_rate ? "#{performance.core_heart_rate} bpm" : '-' %></td>
                <td data-label="km/min"><%= km_min(performance) %></td>
                <td data-label="Notities"><%= performance.notes %></td>
                <% if current_user&.admin? || current_user&.id == performance.user_id %>
                  <td data-label="Acties" class="performance-actions" onclick="event.stopPropagation();">
                    <%= link_to '‚úèÔ∏è', edit_performance_path(performance), class: 'theme-btn track-btn--outline', style: 'padding: 0.5rem 1rem; font-size: 1rem;' %>
                    <%= button_to 'üóëÔ∏è', performance_path(performance), method: :delete, data: { confirm: 'Weet je zeker dat je deze prestatie wilt verwijderen?' }, class: 'theme-btn track-btn--outline danger-btn', style: 'padding: 0.5rem 1rem; font-size: 1rem; background: #ef4444; color: white; border: none;' %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p>Je hebt nog geen prestaties geregistreerd.</p>
    <% end %>
    <h3>Nieuwe tijd/prestatie toevoegen</h3>
    <%= render 'performances/form', performance: Performance.new(user_id: @user.id) %>
  </div>
</div>

<script>
  // Handle clickable rows for performance viewing
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.performance-row.clickable-row').forEach(function(row) {
      row.addEventListener('click', function(e) {
        // Voorkom navigatie als er op een button of link wordt geklikt
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('.performance-actions')) {
          return;
        }
        
        const performanceId = this.dataset.performanceId;
        if (performanceId) {
          window.location.href = `/performances/${performanceId}`;
        }
      });
    });
  });
</script>

