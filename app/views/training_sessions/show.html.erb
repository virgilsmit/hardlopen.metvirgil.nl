<div class="training-details-page prototype-track">
<h1 style="color: #ffffff !important;">Training details</h1>

<% if current_user %>
  <% current_user_attendance = @training_session.attendances.find_by(user_id: current_user.id) %>
  <!-- SECTIE 0: Eigen Status -->
  <section class="own-status-section" style="margin: 2rem 0; padding: 2rem; background: #1f3150; border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: 0 18px 40px rgba(7, 10, 24, 0.45);">
    <h2 style="color: #ffffff !important; font-size: 1.5rem; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">Mijn Status</h2>
    
    <div class="own-status-containers-wrapper" style="display: flex; gap: 2rem; margin-bottom: 0;">
      <!-- Container 1: Aanwezig -->
      <div class="own-status-container own-status-aanwezig" style="flex: 1; background: rgba(30, 227, 207, 0.1); border: 2px solid <%= current_user_attendance&.status.to_s == 'aanwezig' ? 'rgba(30, 227, 207, 0.8)' : 'rgba(30, 227, 207, 0.3)' %>; border-radius: 16px; padding: 1.5rem;">
        <h3 style="color: #1ee3cf !important; font-size: 1.25rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(30, 227, 207, 0.3);">Aanwezig</h3>
        <div style="text-align: center;">
          <%= form_with url: attendances_path, method: :post, local: true, class: 'inline-form' do |f| %>
            <%= f.hidden_field :user_id, value: current_user.id %>
            <%= f.hidden_field :training_session_id, value: @training_session.id %>
            <%= f.hidden_field :status, value: 'aanwezig' %>
            <button type="submit" class="theme-btn attendance-btn attendance-aanwezig-btn" style="background: #1ee3cf; color: #0c1730; padding: 0.75rem 2rem; font-size: 1rem; font-weight: 600; border-radius: 8px; width: 100%; <%= (current_user_attendance.nil? || current_user_attendance.status.to_s == 'aanwezig') ? 'opacity: 1; box-shadow: 0 0 0 3px rgba(30, 227, 207, 0.5);' : 'opacity: 0.35;' %>">
              <%= (current_user_attendance&.status.to_s == 'aanwezig') ? '✓ Aanwezig' : 'Markeer als Aanwezig' %>
            </button>
          <% end %>
        </div>
      </div>

      <!-- Container 2: Afwezig -->
      <% afwezig_active = current_user_attendance&.status.to_s == 'afwezig' %>
      <div class="own-status-container own-status-afwezig" style="flex: 1; background: rgba(255, 107, 53, 0.1); border: 2px solid <%= afwezig_active ? 'rgba(255, 107, 53, 0.8)' : 'rgba(255, 107, 53, 0.3)' %>; border-radius: 16px; padding: 1.5rem;">
        <h3 style="color: #ff6b35 !important; font-size: 1.25rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 107, 53, 0.3);">Afwezig</h3>
        <div style="text-align: center;">
          <% unless afwezig_active %>
            <%= form_with url: attendances_path, method: :post, local: true, html: { class: 'afwezig-form', data: { session_id: @training_session.id } }, class: 'inline-form' do |f| %>
              <%= f.hidden_field :user_id, value: current_user.id %>
              <%= f.hidden_field :training_session_id, value: @training_session.id %>
              <%= f.hidden_field :status, value: 'afwezig' %>
              <div class="afwezig-container">
                <button type="submit" class="theme-btn afwezig-btn inactive" data-session-id="<%= @training_session.id %>" style="background: #ff6b35; color: #0c1730; padding: 0.75rem 2rem; font-size: 1rem; font-weight: 600; border-radius: 8px; width: 100%; margin-bottom: 1rem; opacity: 0.35;">Markeer als Afwezig</button>
                <div class="afwezig-note-field" id="afwezig-note-<%= @training_session.id %>" style="display: none;">
                  <%= f.text_field :note, value: nil, placeholder: 'Reden (optioneel)', class: 'note-input-full', style: 'width: 100%; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; background: rgba(255, 255, 255, 0.1); font-size: 0.9rem; margin-bottom: 0.75rem;' %>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="afwezig-container">
              <button type="button" class="theme-btn afwezig-submit" style="background: #ff6b35; color: #0c1730; padding: 0.75rem 2rem; font-size: 1rem; font-weight: 600; border-radius: 8px; width: 100%; margin-bottom: 1rem;">✓ Afwezig</button>
            </div>
          <% end %>
          <% if afwezig_active %>
            <div class="afwezig-note-field" id="afwezig-note-<%= @training_session.id %>">
              <%= form_with model: current_user_attendance, url: attendance_path(current_user_attendance), method: :patch, local: true do |f_update| %>
                <%= f_update.hidden_field :user_id, value: current_user.id %>
                <%= f_update.hidden_field :training_session_id, value: @training_session.id %>
                <%= f_update.hidden_field :status, value: 'afwezig' %>
                <%= f_update.text_field :note, value: current_user_attendance.note, placeholder: 'Reden (optioneel)', style: 'width: 100%; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; background: rgba(255, 255, 255, 0.1); font-size: 0.9rem; margin-bottom: 0.5rem;' %>
                <button type="submit" class="theme-btn" style="background: #1ee3cf; color: #0c1730; padding: 0.5rem 1.5rem; font-size: 0.9rem; font-weight: 600; border-radius: 8px; width: 100%;">Reden bijwerken</button>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </section>
<% end %>

<% if current_user.admin? %>
  <% users = @training_session.group&.users&.select { |u| (u.has_role?(:trainer) || (u.has_role?(:trainer) == false && User.alleen_actieve_lopers.include?(u))) }&.sort_by(&:name) || [] %>
<% else %>
  <% users = @training_session.group&.users&.select { |u| u.has_role?(:trainer) == false && User.alleen_actieve_lopers.include?(u) }&.sort_by(&:name) || [] %>
<% end %>
<%
  session_day_value = @training_session.dag.to_s.downcase
  if session_day_value.blank? && @training_session.date.present?
    begin
      session_day_value = I18n.l(@training_session.date, format: '%A').to_s.downcase
    rescue
      session_day_value = @training_session.date.strftime('%A').to_s.downcase
    end
  end
  recognized_day = %w[dinsdag zaterdag].find { |dag| session_day_value.include?(dag) }
  training_day_active = lambda do |user|
    recognized_day.blank? || user.training_days.blank? || user.training_days.map(&:downcase).include?(recognized_day)
  end
%>
<% users.unshift(users.delete(current_user)) if users.include?(current_user) %>
<% # Sorteer de overige gebruikers op status: afwezig -> aanwezig -> geen status %>
<% overige = users[1..-1] || [] %>
<% afwezig = overige.select { |u| @training_session.attendances.find_by(user: u)&.status == 'afwezig' } %>
<% aanwezig = overige.select { |u| @training_session.attendances.find_by(user: u)&.status == 'aanwezig' } %>
<% geen_status = overige - afwezig - aanwezig %>
<% gesorteerde_users = [users.first] + afwezig + aanwezig + geen_status %>

<% actieve_lopers = (@training_session.group&.users || []).select { |u| u.has_role?(:trainer) == false && User.alleen_actieve_lopers.include?(u) && training_day_active.call(u) } %>
<% aanwezig_count = actieve_lopers.count { |u| @training_session.attendances.find_by(user: u)&.status == 'aanwezig' } %>
<% afwezig_count = actieve_lopers.count { |u| @training_session.attendances.find_by(user: u)&.status == 'afwezig' } %>
<% totaal_lopers = actieve_lopers.count %>

<% aanwezige_trainers = @training_session.group&.users&.select { |u| u.has_role?(:trainer) && @training_session.attendances.find_by(user: u)&.status == 'aanwezig' } || [] %>
<% afwezige_trainers = @training_session.group&.users&.select { |u| u.has_role?(:trainer) && @training_session.attendances.find_by(user: u)&.status == 'afwezig' } || [] %>

<!-- SECTIE 1: Training Details -->
<section class="training-details-section" style="margin: 2rem 0; padding: 2rem; background: #1f3150; border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: 0 18px 40px rgba(7, 10, 24, 0.45);">
  <h2 style="color: #ffffff !important; font-size: 1.5rem; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">Training Details</h2>
  
  <div class="training-details-list" style="display: flex !important; flex-direction: column !important; gap: 1rem !important; width: 100% !important; max-width: 100% !important;">
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Week</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;"><%= @training_session.week %></div>
    </div>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Datum</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;"><%= @training_session.date %></div>
    </div>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Dag</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;">
        <% if @training_session.dag.to_s.downcase == 'zaterdag' %>
          Zaterdag 08:45
        <% elsif @training_session.dag.to_s.downcase == 'dinsdag' %>
          Dinsdag 18:45
        <% else %>
          <%= @training_session.dag %>
        <% end %>
      </div>
    </div>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Training</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff; word-wrap: break-word;"><%= @training_session.description %></div>
    </div>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Loopscholing</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff; word-wrap: break-word;"><%= @training_session.loopscholing %></div>
    </div>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Trainer</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;"><%= @training_session.trainer&.name || '-' %></div>
    </div>
    
    <% if aanwezige_trainers.any? %>
      <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
        <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Aanwezige trainers</div>
        <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;"><%= aanwezige_trainers.map(&:name).join(', ') %></div>
      </div>
    <% end %>
    
    <% if afwezige_trainers.any? %>
      <div class="detail-item" style="padding: 1rem; background: rgba(255, 107, 53, 0.1); border-radius: 12px; border: 1px solid rgba(255, 107, 53, 0.3);">
        <div style="font-size: 0.75rem; font-weight: 600; color: #ff6b35; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Afwezige trainers</div>
        <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;">
          <% afwezige_trainers.each do |trainer| %>
            <% trainer_attendance = @training_session.attendances.find_by(user_id: trainer.id) %>
            <div style="margin-bottom: 0.5rem;">
              <strong style="color: #ff6b35;"><%= trainer.name %></strong>
              <% if trainer_attendance&.note.present? %>
                <span style="margin-left: 0.5em; color: #c7d7ff; font-style: italic; font-size: 0.9rem;">- <%= trainer_attendance.note %></span>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Locatie</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;"><%= @training_session.locatie %></div>
    </div>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Groep</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;"><%= @training_session.group&.name || '-' %></div>
    </div>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Fase</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;"><%= @training_session.fase %></div>
    </div>
    
    <div class="detail-item" style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 0.75rem; font-weight: 600; color: #1ee3cf; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Wedstrijd</div>
      <div style="font-size: 1.125rem; font-weight: 500; color: #ffffff;"><%= @training_session.wedstrijd %></div>
    </div>
  </div>
  
  <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.2);">
    <h3 style="color: #ffffff !important; font-size: 1.25rem; margin-bottom: 1rem;">Kern overzicht</h3>
    <ul class="core-list" style="list-style:none; padding:0; margin: 0;">
      <% human_core(@training_session.structured_core, current_user).each do |line| %>
        <li style="padding: 1rem 1.25rem; margin-bottom: 0.75rem; background: rgba(255, 255, 255, 0.05); border-left: 3px solid #1ee3cf; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.95rem; line-height: 1.6; color: #ffffff;">✅ <%= line %></li>
      <% end %>
    </ul>
  </div>
</section>

<!-- SECTIE 2: Statistieken -->
<section class="training-stats-section" style="margin: 2rem 0; padding: 2rem; background: linear-gradient(140deg, #1e3050, #2b4676); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: 0 18px 40px rgba(7, 10, 24, 0.45);">
  <h2 style="color: #ffffff !important; font-size: 1.5rem; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">Statistieken</h2>
  <div style="display: flex !important; flex-direction: column !important; gap: 1.5rem !important; width: 100% !important;">
    <div style="text-align: center;">
      <div style="font-size: 2rem; font-weight: 700; color: #ffffff; margin-bottom: 0.5rem;"><%= totaal_lopers %></div>
      <div style="font-size: 0.875rem; color: #c7d7ff; text-transform: uppercase; letter-spacing: 0.05em;">Totaal</div>
    </div>
    <div style="text-align: center;">
      <div style="font-size: 2rem; font-weight: 700; color: #1ee3cf; margin-bottom: 0.5rem;"><%= aanwezig_count %></div>
      <div style="font-size: 0.875rem; color: #c7d7ff; text-transform: uppercase; letter-spacing: 0.05em;">Aanwezig</div>
    </div>
    <div style="text-align: center;">
      <div style="font-size: 2rem; font-weight: 700; color: #ff6b35; margin-bottom: 0.5rem;"><%= afwezig_count %></div>
      <div style="font-size: 0.875rem; color: #c7d7ff; text-transform: uppercase; letter-spacing: 0.05em;">Afwezig</div>
    </div>
  </div>
</section>

<!-- SECTIE 3: Deelnemers -->
<section class="training-participants-section" style="margin: 2rem 0; padding: 2rem; background: #1f3150; border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.12); box-shadow: 0 18px 40px rgba(7, 10, 24, 0.45);">
  <h2 style="color: #ffffff !important; font-size: 1.5rem; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">Deelnemers</h2>

  <% attendance_lookup = @training_session.attendances.index_by(&:user_id) %>
  <% aanwezig_users = gesorteerde_users.select { |u| attendance_lookup[u.id]&.status.to_s == 'aanwezig' } %>
  <% afwezig_users = gesorteerde_users.select { |u| attendance_lookup[u.id]&.status.to_s == 'afwezig' } %>
  <% onbekend_users = gesorteerde_users - aanwezig_users - afwezig_users %>

  <%
    structural_absent_users = if recognized_day.present?
      gesorteerde_users.select do |u|
        u.training_days.present? && !u.training_days.map(&:downcase).include?(recognized_day)
      end
    else
      []
    end
  %>

  <div class="participants-containers-wrapper" style="display: flex; gap: 2rem; margin-bottom: 2rem;">
    <!-- Container 1: Aanwezig -->
    <div class="participants-container participants-aanwezig" style="flex: 1; background: rgba(30, 227, 207, 0.1); border: 1px solid rgba(30, 227, 207, 0.3); border-radius: 16px; padding: 1.5rem;">
      <h3 style="color: #1ee3cf !important; font-size: 1.25rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(30, 227, 207, 0.3);">Aanwezig</h3>
      <div class="participants-list">
        <% non_structural_onbekend = onbekend_users - structural_absent_users %>
        <% if aanwezig_users.any? || non_structural_onbekend.any? %>
          <% aanwezig_users.each do |user| %>
            <% attendance = attendance_lookup[user.id] %>
            <div class="participant-item" style="padding: 1rem; margin-bottom: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                  <span style="display:inline-block; width:12px;height:12px;border-radius:50%;background:#1ee3cf;"></span>
                  <strong style="color: #ffffff !important; font-weight: 600;"><%= user.name %></strong>
                </div>
                <% if user == current_user || current_user.admin? || (current_user.has_role?(:trainer) && (@training_session.group&.hoofdtrainer_id == current_user.id || @training_session.group&.medetrainer_id == current_user.id)) %>
                  <%= form_with url: attendances_path, method: :post, local: true, style: 'display:inline; width: 40%; max-width: 220px;' do |f| %>
                    <%= f.hidden_field :user_id, value: user.id %>
                    <%= f.hidden_field :training_session_id, value: @training_session.id %>
                    <%= f.hidden_field :status, value: 'afwezig' %>
                    <%= f.text_field :note, placeholder: 'Reden (optioneel)', style: 'width: 100%; padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #ffffff; background: rgba(255,255,255,0.08); font-size: 0.85rem; margin-bottom: 0.5rem;' %>
                    <button type="submit" class="theme-btn" style="background:#ff6b35; color:#0c1730; padding:0.4em 0.8em; font-size:0.85em; width: 100%;">Afwezig</button>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
          <% non_structural_onbekend.each do |user| %>
            <div class="participant-item" style="padding: 1rem; margin-bottom: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 12px; opacity: 0.7;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                  <span style="display:inline-block; width:12px;height:12px;border-radius:50%;background:#9ca3af;"></span>
                  <strong style="color: #ffffff !important; font-weight: 600;"><%= user.name %></strong>
                  <span style="font-size: 0.75rem; color:#1ee3cf; background: rgba(30,227,207,0.15); border: 1px dashed rgba(30,227,207,0.5); padding: 0.2rem 0.5rem; border-radius: 999px;">Nog niet gereageerd (standaard aanwezig)</span>
                </div>
                <% if user == current_user || current_user.admin? || (current_user.has_role?(:trainer) && (@training_session.group&.hoofdtrainer_id == current_user.id || @training_session.group&.medetrainer_id == current_user.id)) %>
                  <%= form_with url: attendances_path, method: :post, local: true, style: 'display:inline; width: 40%; max-width: 220px;' do |f| %>
                    <%= f.hidden_field :user_id, value: user.id %>
                    <%= f.hidden_field :training_session_id, value: @training_session.id %>
                    <%= f.hidden_field :status, value: 'aanwezig' %>
                    <button type="submit" class="theme-btn" style="background:#1ee3cf; color:#0c1730; padding:0.4em 0.8em; font-size:0.85em; width: 100%; margin-bottom: 0.5rem;">Bevestig Aanwezig</button>
                    <div style="margin-top: 0.5rem;">
                      <%= f.hidden_field :status, value: 'afwezig', name: 'attendance[status_override]' %>
                    </div>
                  <% end %>
                  <%= form_with url: attendances_path, method: :post, local: true, style: 'display:inline; width: 40%; max-width: 220px; margin-left: 0.75rem;' do |f| %>
                    <%= f.hidden_field :user_id, value: user.id %>
                    <%= f.hidden_field :training_session_id, value: @training_session.id %>
                    <%= f.hidden_field :status, value: 'afwezig' %>
                    <%= f.text_field :note, placeholder: 'Reden (optioneel)', style: 'width: 100%; padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #ffffff; background: rgba(255,255,255,0.08); font-size: 0.85rem; margin-bottom: 0.5rem;' %>
                    <button type="submit" class="theme-btn" style="background:#ff6b35; color:#0c1730; padding:0.4em 0.8em; font-size:0.85em; width: 100%;">Afwezig</button>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <p style="color: rgba(255, 255, 255, 0.5); font-style: italic; text-align: center; padding: 2rem 0;">Geen deelnemers aanwezig</p>
        <% end %>
      </div>
    </div>

    <!-- Container 2: Afwezig -->
    <div class="participants-container participants-afwezig" style="flex: 1; background: rgba(255, 107, 53, 0.1); border: 1px solid rgba(255, 107, 53, 0.3); border-radius: 16px; padding: 1.5rem;">
      <h3 style="color: #ff6b35 !important; font-size: 1.25rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 107, 53, 0.3);">Afwezig</h3>
      <div class="participants-list">
        <% combined_afwezig = (afwezig_users + structural_absent_users).uniq %>
        <% if combined_afwezig.any? %>
          <% combined_afwezig.each do |user| %>
            <% attendance = attendance_lookup[user.id] %>
            <% structureel_afwezig = structural_absent_users.include?(user) && attendance.nil? %>
            <div class="participant-item" style="padding: 1rem; margin-bottom: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: <%= (attendance&.note.present? || structureel_afwezig) ? '0.75rem' : '0' %>;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                  <span style="display:inline-block; width:12px;height:12px;border-radius:50%;background:#ff6b35;"></span>
                  <strong style="color: #ffffff !important; font-weight: 600;"><%= user.name %></strong>
                </div>
                <% if user == current_user || current_user.admin? || (current_user.has_role?(:trainer) && (@training_session.group&.hoofdtrainer_id == current_user.id || @training_session.group&.medetrainer_id == current_user.id)) %>
                  <%= form_with url: attendances_path, method: :post, local: true, style: 'display:inline;' do |f| %>
                    <%= f.hidden_field :user_id, value: user.id %>
                    <%= f.hidden_field :training_session_id, value: @training_session.id %>
                    <%= f.hidden_field :status, value: 'aanwezig' %>
                    <button type="submit" class="theme-btn" style="background:#1ee3cf; color:#0c1730; padding:0.3em 0.8em; font-size:0.85em;">Aanwezig</button>
                  <% end %>
                <% end %>
              </div>
              <% if attendance&.note.present? %>
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                  <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.85rem; margin: 0;"><strong style="color: #ff6b35;">Reden:</strong> <%= attendance.note %></p>
                </div>
              <% elsif structureel_afwezig %>
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                  <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin: 0;"><strong style="color: #ff6b35;">Structureel:</strong> Deze loper staat niet ingeschreven voor <%= recognized_day.capitalize %>.</p>
                </div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p style="color: rgba(255, 255, 255, 0.5); font-style: italic; text-align: center; padding: 2rem 0;">Geen deelnemers afwezig</p>
        <% end %>
      </div>
    </div>
  </div>

  <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.2);">
    <h3 style="color: #ffffff !important; font-size: 1.25rem; margin-bottom: 1rem;">Niet aangemeld</h3>
    <ul id="not_signed_up_list" style="list-style: none; padding: 0; margin: 0;">
  <% users_na = User.alleen_actieve_lopers.order(:name).select { |u| training_day_active.call(u) } %>
      <% users_na.unshift(users_na.delete(current_user)) if users_na.include?(current_user) %>
      <% users_na.each do |user| %>
        <% attendance = @training_session.attendances.find_by(user: user) %>
        <% if attendance.nil? %>
          <li style="padding: 0.75rem 1rem; margin-bottom: 0.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 12px; color: #ffffff; font-size: 0.95rem;"><%= user.name %></li>
        <% end %>
      <% end %>
    </ul>
  </div>

  <% if @training_session.group && @training_session.group.hoofdtrainer_id %>
    <% trainers = [@training_session.group.hoofdtrainer] %>
    <% trainers << @training_session.group.medetrainer if @training_session.group.medetrainer_id && @training_session.group.medetrainer_id != @training_session.group.hoofdtrainer_id %>
    <% afwezige_trainers_section = trainers.compact.select { |trainer| (att = @training_session.attendances.find_by(user_id: trainer.id)) && att.status == 'afwezig' } %>
    <% if afwezige_trainers_section.any? %>
      <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.2);">
        <h3 style="color: #ffffff !important; font-size: 1.25rem; margin-bottom: 1rem;">Afwezige trainers</h3>
        <ul style="list-style:none;padding:0; margin: 0;">
          <% afwezige_trainers_section.each do |trainer| %>
            <% attendance = @training_session.attendances.find_by(user_id: trainer.id) %>
            <li style="margin-bottom:1em; padding: 1rem 1.25rem; background: rgba(255, 107, 53, 0.1); border: 1px solid rgba(255, 107, 53, 0.3); border-radius: 12px;">
              <strong style="color: #ff6b35;"><%= trainer.name %></strong>
              <span style="color:#ff6b35;">(afwezig)</span>
              <% if attendance.note.present? %>
                <span style="margin-left:0.5em;color:#c7d7ff;font-style:italic;">- <%= attendance.note %></span>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  <% end %>
</section>

<% if current_user&.admin? || current_user&.has_role?(:trainer) %>
  <div style="margin-top:1.2em;">
    <%= link_to 'Log aanwezige lopers', log_attendance_training_session_path(@training_session), class:'theme-btn', style:'background:#34c759;color:#fff;' %>
  </div>
<% end %>

<% if current_user&.admin? || (current_user&.has_role?(:trainer) && (@training_session.group&.hoofdtrainer_id == current_user.id || @training_session.group&.medetrainer_id == current_user.id)) %>
  <div style="margin-bottom:1.5em;">
    <%= link_to 'Bewerken', edit_training_session_path(@training_session), class: 'theme-btn', style: 'background:#1976d2;' %>
  </div>
<% elsif current_user&.has_role?(:trainer) %>
  <div style="margin-bottom:1.5em;">
    <%= link_to 'Trainer wijzigen', edit_training_session_path(@training_session), class: 'theme-btn', style: 'background:#ff9800;' %>
  </div>
<% end %>
</div> 