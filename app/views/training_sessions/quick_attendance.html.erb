<%
  # Zet variabelen direct in de view (controller code wordt niet uitgevoerd door een redirect)
  @training_session ||= TrainingSession.find_by(id: params[:id])
  
  # Check toegang - alleen trainers en admins hebben toegang
  has_access = @training_session && current_user && (is_admin? || current_user.has_role?(:trainer) || current_user.has_role?(:admin))
  
  # Haal alle actieve lopers op
  session_day_value = @training_session.dag.to_s.downcase
  recognized_day = %w[dinsdag zaterdag].find { |dag| session_day_value.include?(dag) }
  
  if current_user.admin?
    all_users = @training_session.group&.users&.select { |u| 
      (u.has_role?(:trainer) || (u.has_role?(:trainer) == false && User.alleen_actieve_lopers.include?(u))) 
    } || []
  else
    all_users = @training_session.group&.users&.select { |u| 
      u.has_role?(:trainer) == false && User.alleen_actieve_lopers.include?(u) 
    } || []
  end
  
  # Filter op actieve training dag
  users_on_day = all_users.select do |u|
    recognized_day.blank? || u.training_days.blank? || u.training_days.map(&:downcase).include?(recognized_day)
  end
  
  # Voeg lopers toe die zich expliciet hebben aangemeld/afgemeld (ook als ze niet op deze dag trainen)
  @attendances = @training_session.attendances.index_by(&:user_id) if @training_session
  explicit_attendees = @training_session.attendances.map(&:user).compact.select { |u|
    User.alleen_actieve_lopers.include?(u) && !users_on_day.include?(u)
  }
  
  # Combineer beide groepen en sorteer
  @users = (users_on_day + explicit_attendees).uniq.sort_by(&:name)
%>

<% if has_access %>
<div class="quick-attendance-page" style="background: #f8f9fa; min-height: 100vh; padding: 1rem;">
  <div style="max-width: 800px; margin: 0 auto;">
    <h1 style="color: #1a2332; font-size: 1.8rem; margin-bottom: 0.5rem;">
      ‚ö° Snelle Presentielijst
    </h1>
    
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #ffeaa7;">
      <p style="color: #856404; margin: 0; font-size: 0.95rem; line-height: 1.6;">
        <strong style="color: #856404;">Instructie:</strong> Klik op de lopers die <strong>aanwezig</strong> zijn. 
        Klik op <strong>"Presentielijst Afsluiten"</strong> om alle niet-aangeklikte lopers automatisch als afwezig te markeren.
      </p>
    </div>

    <!-- Training info -->
    <div style="background: #ffffff; border: 2px solid #1ee3cf; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h2 style="color: #1ee3cf; font-size: 1.3rem; margin-bottom: 1rem;">Training Details</h2>
      <div style="color: #1a2332;">
        <p style="margin: 0.5rem 0;"><strong>Datum:</strong> <%= l(@training_session.date, format: :long) %></p>
        <p style="margin: 0.5rem 0;"><strong>Dag:</strong> <%= @training_session.dag.capitalize %></p>
        <p style="margin: 0.5rem 0;"><strong>Training:</strong> <%= @training_session.description %></p>
        <p style="margin: 0.5rem 0;"><strong>Groep:</strong> <%= @training_session.group&.name || '-' %></p>
      </div>
    </div>

    <%= form_with url: finalize_attendance_training_session_path(@training_session), method: :post, local: true, id: 'quick-attendance-form' do |f| %>
      <!-- Deelnemers lijst -->
      <div style="background: #ffffff; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2 style="color: #1a2332; font-size: 1.3rem; margin-bottom: 1.5rem;">
          Deelnemers (<span id="present-count" style="color: #1ee3cf;">0</span>/<%= @users.count %>)
        </h2>
        
        <div id="participants-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
          <% @users.each do |user| %>
            <% attendance = @attendances[user.id] %>
            <% is_present = attendance&.status.to_s == 'aanwezig' %>
            <% is_absent = attendance&.status.to_s == 'afwezig' %>
            
            <div class="participant-card <%= is_present ? 'present' : '' %> <%= is_absent ? 'absent' : '' %>" 
                 data-user-id="<%= user.id %>"
                 style="
                   background: <%= is_present ? '#d1f4e8' : (is_absent ? '#ffe5db' : '#f8f9fa') %>;
                   border: 2px solid <%= is_present ? '#1ee3cf' : (is_absent ? '#ff6b35' : '#e5e7eb') %>;
                   border-radius: 12px;
                   padding: 1.25rem;
                   cursor: pointer;
                   transition: all 0.2s ease;
                   position: relative;
                 "
                 onclick="togglePresence(this, <%= user.id %>)">
              
              <!-- Checkmark icon -->
              <div class="checkmark" style="
                position: absolute;
                top: 0.75rem;
                right: 0.75rem;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: <%= is_present ? '#1ee3cf' : '#e5e7eb' %>;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
                color: <%= is_present ? '#ffffff' : '#9ca3af' %>;
                transition: all 0.2s ease;
              ">
                <%= is_present ? '‚úì' : '' %>
              </div>
              
              <!-- User name -->
              <div style="color: #1a2332; font-weight: 600; font-size: 1.05rem; margin-bottom: 0.5rem; padding-right: 2.5rem;">
                <%= user.name %>
              </div>
              
              <!-- Status badge -->
              <div class="status-badge" style="
                display: inline-block;
                padding: 0.25rem 0.75rem;
                border-radius: 999px;
                font-size: 0.8rem;
                font-weight: 600;
                background: <%= is_present ? '#d1f4e8' : (is_absent ? '#ffe5db' : '#f1f3f5') %>;
                color: <%= is_present ? '#0d9488' : (is_absent ? '#c2410c' : '#6b7280') %>;
              ">
                <%= is_present ? 'Aanwezig' : (is_absent ? 'Afwezig' : 'Geen status') %>
              </div>
              
              <!-- Hidden checkbox -->
              <%= check_box_tag 'present_users[]', user.id, is_present, 
                  id: "user_#{user.id}", 
                  style: 'display: none;' %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Action buttons -->
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button type="button" 
                onclick="selectAll()"
                class="theme-btn" 
                style="flex: 1; min-width: 200px; background: #1ee3cf; color: #0c1730; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700; border-radius: 12px; box-shadow: 0 4px 12px rgba(30, 227, 207, 0.3);">
          ‚úì Selecteer Alles
        </button>
        
        <button type="button" 
                onclick="deselectAll()"
                class="theme-btn" 
                style="flex: 1; min-width: 200px; background: rgba(255, 255, 255, 0.1); color: #ffffff; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.3);">
          ‚úó Deselecteer Alles
        </button>
      </div>

      <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <button type="submit" 
                class="theme-btn" 
                style="flex: 2; min-width: 250px; background: linear-gradient(135deg, #ff6b35, #ff8c5a); color: #ffffff; padding: 1.25rem 2.5rem; font-size: 1.2rem; font-weight: 700; border-radius: 12px; box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
          üîí Presentielijst Afsluiten
        </button>
        
        <%= link_to training_session_path(@training_session), 
            class: 'theme-btn', 
            style: 'flex: 1; min-width: 150px; background: rgba(255, 255, 255, 0.08); color: #ffffff; padding: 1.25rem 2rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.2); text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center;' do %>
          ‚Üê Annuleren
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
  function togglePresence(card, userId) {
    const checkbox = document.getElementById('user_' + userId);
    const checkmark = card.querySelector('.checkmark');
    const statusBadge = card.querySelector('.status-badge');
    
    // Toggle checkbox
    checkbox.checked = !checkbox.checked;
    
    // Update card styling
    if (checkbox.checked) {
      card.classList.add('present');
      card.classList.remove('absent');
      card.style.background = '#d1f4e8';
      card.style.borderColor = '#1ee3cf';
      card.style.boxShadow = '0 0 0 3px rgba(30, 227, 207, 0.15)';
      
      checkmark.style.background = '#1ee3cf';
      checkmark.style.color = '#ffffff';
      checkmark.textContent = '‚úì';
      
      statusBadge.style.background = '#d1f4e8';
      statusBadge.style.color = '#0d9488';
      statusBadge.textContent = 'Aanwezig';
    } else {
      card.classList.remove('present');
      card.style.background = '#f8f9fa';
      card.style.borderColor = '#e5e7eb';
      card.style.boxShadow = 'none';
      
      checkmark.style.background = '#e5e7eb';
      checkmark.style.color = '#9ca3af';
      checkmark.textContent = '';
      
      statusBadge.style.background = '#f1f3f5';
      statusBadge.style.color = '#6b7280';
      statusBadge.textContent = 'Geen status';
    }
    
    updateCount();
  }
  
  function selectAll() {
    document.querySelectorAll('.participant-card').forEach(card => {
      const userId = card.dataset.userId;
      const checkbox = document.getElementById('user_' + userId);
      if (!checkbox.checked) {
        togglePresence(card, userId);
      }
    });
  }
  
  function deselectAll() {
    document.querySelectorAll('.participant-card').forEach(card => {
      const userId = card.dataset.userId;
      const checkbox = document.getElementById('user_' + userId);
      if (checkbox.checked) {
        togglePresence(card, userId);
      }
    });
  }
  
  function updateCount() {
    const count = document.querySelectorAll('input[name="present_users[]"]:checked').length;
    document.getElementById('present-count').textContent = count;
  }
  
  // Initialize count on page load
  updateCount();
  
  // Confirm before submitting
  const form = document.getElementById('quick-attendance-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      const count = document.querySelectorAll('input[name="present_users[]"]:checked').length;
      const total = <%= @users.count %>;
      const absent = total - count;
      
      console.log('[FORM SUBMIT] Present:', count, 'Absent:', absent);
      
      if (!confirm(`Je gaat de presentielijst afsluiten:\n\n‚úì ${count} aanwezig\n‚úó ${absent} afwezig\n\nWeet je het zeker?`)) {
        e.preventDefault();
        console.log('[FORM SUBMIT] Cancelled by user');
        return false;
      }
      
      console.log('[FORM SUBMIT] Confirmed - submitting form');
      // Form wordt nu normaal verzonden
    });
  } else {
    console.error('[FORM ERROR] Form not found!');
  }
</script>

<style>
  @media (max-width: 768px) {
    #participants-grid {
      grid-template-columns: 1fr !important;
    }
  }
  
  .participant-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }
  
  .participant-card.present:hover {
    box-shadow: 0 4px 12px rgba(30, 227, 207, 0.4) !important;
  }
</style>
<% else %>
  <div style="background: #f8f9fa; min-height: 100vh; padding: 2rem; display: flex; align-items: center; justify-content: center;">
    <div style="text-align: center;">
      <h1 style="color: #1a2332; font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è Geen toegang</h1>
      <p style="color: #6b7280; font-size: 1.2rem; margin-bottom: 2rem;">Je moet ingelogd zijn als trainer of admin om deze pagina te bekijken.</p>
      <%= link_to 'Ga naar login', login_path, class: 'theme-btn', style: 'background: #1ee3cf; color: #0c1730; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700; border-radius: 12px; text-decoration: none; display: inline-block;' %>
    </div>
  </div>
<% end %>
